<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stress Prediction Auth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            /* Font from theme */
            font-family: 'Inter', sans-serif;
        }
        body {
            /* Background gradient from theme (acts as fallback) */
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1419 100%);
            min-height: 100vh;
        }
        
        /* --- ENFORCING MOBILE VIEWPORT (from theme) --- */
        /* This rule constrains the app container to 450px wide, just like the dashboard file */
        #app-container {
            /* Max width to simulate a phone screen on desktop */
            max-width: 450px; 
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 0 50px rgba(6, 182, 212, 0.1); 
            min-height: 100vh;
            /* Container gets its own background, same as body */
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1419 100%);
            position: relative;
            overflow-x: hidden;
        }

        /* --- Dark/Glass look Styles (from theme) --- */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .gradient-text {
            background: linear-gradient(135deg, #06b6d4 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .pulse-glow {
            animation: pulse-glow 3s ease-in-out infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(6, 182, 212, 0.2); }
            50% { box-shadow: 0 0 25px rgba(6, 182, 212, 0.4); }
        }

        /* Simple loading spinner (color updated to theme's cyan) */
        .spinner {
            border-top-color: #06b6d4; /* Theme cyan */
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app-container" class="flex items-center justify-center p-4">
        </div>

    <div id="message-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300" aria-modal="true" role="dialog">
        <div class="glass-card p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-xl font-semibold mb-3 text-white">Message</h3> <p id="modal-content" class="text-gray-300 mb-4"></p> <button id="modal-close-btn" class="w-full py-2.5 px-4 bg-gradient-to-r from-cyan-500 to-purple-600 text-white rounded-xl hover:from-cyan-400 hover:to-purple-500 transition duration-150 font-medium shadow-md">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth, onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, 
            GoogleAuthProvider, signInWithPopup, fetchSignInMethodsForEmail, sendEmailVerification 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARS & CONFIG ---
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const firebaseConfig = {
            apiKey: "AIzaSyDd7NoHbxWpbhERrKYT2Pj2dhHWu4LhXJA",
            authDomain: "stresspredictapp.firebaseapp.com",
            projectId: "stresspredictapp",
            storageBucket: "stresspredictapp.firebasestorage.app",
            messagingSenderId: "333834939182",
            appId: "1:333834939182:web:432df2fad26f37baa328bf",
            measurementId: "G-CFJ2B9FG9J"
        };
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined'
            ? __initial_auth_token
            : null;
        // --- END GLOBAL VARS ---

        let app;
        let auth;
        let db;
        let currentView = 'login'; 
        let isSigningIn = false;
        let modalCallback = null; 

        const appContainer = document.getElementById('app-container');
        const modal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            if (modalCallback) {
                modalCallback();
                modalCallback = null; 
            }
        });

        function showMessage(title, message, callback = null) {
            modalTitle.textContent = title;
            modalContent.innerHTML = message; 
            modal.classList.remove('hidden'); 
            modalCallback = callback; 
        }

        // --- Icon Components ---

        /**
         * App Logo Icon (from theme)
         */
        function AppLogoIcon() {
            return `
            <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-purple-600 rounded-lg flex items-center justify-center pulse-glow">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
            </div>
            `;
        }

        function GoogleIcon() {
            return `
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="w-5 h-5 mr-3">
                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.04l7.65 5.92C11.3 14.54 17.5 9.5 24 9.5z"></path>
                <path fill="#4285F4" d="M46.61 24c0-.98-.1-1.85-.25-2.73H24v5.18h12.55c-.56 2.87-2.31 5.2-4.95 6.84l7.65 5.92c4.7-4.57 7.42-11.45 7.42-18.71z"></path>
                <path fill="#FBBC05" d="M10.22 30.74l-7.65-5.92C1.38 27.56 1 30.68 1 34c0 3.32.38 6.44 1.57 9.28l7.65-5.92c-.75-1.81-1.17-3.72-1.17-5.34z"></path>
                <path fill="#34A853" d="M24 48c6.47 0 11.9-2.38 16.19-6.39l-7.65-5.92c-2.64 1.64-4.39 3.97-4.95 6.84H24v-5.18c-6.5 0-12.7-5.04-14.86-10.96l-7.65 5.92C6.51 42.62 14.62 48 24 48z"></path>
                <path fill="none" d="M0 0h48v48H0z"></path>
            </svg>`;
        }

        // Updated icon color to theme's cyan
        function EmailSentIcon(className = "w-12 h-12 text-cyan-400") { 
            return `
            <svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
            </svg>`;
        }

        async function checkEmailStatus() {
            const emailInput = document.getElementById('email');
            const email = emailInput ? emailInput.value.trim() : '';
            const statusMessage = document.getElementById('email-status-message');
            
            statusMessage.innerHTML = ''; 
            statusMessage.className = 'text-sm'; 

            if (!email || !email.includes('@') || email.length < 5) {
                return;
            }

            try {
                // Use theme's text colors
                statusMessage.innerHTML = `<span class="text-gray-500">Checking email status...</span>`;
                
                const methods = await fetchSignInMethodsForEmail(auth, email);
                const isRegistered = methods && methods.length > 0;
                
                if (isRegistered) {
                    // Use theme's success/info colors (green from theme)
                    statusMessage.innerHTML = `<span class="text-green-400 font-medium mt-1">✅ Registered: Use this email to sign in.</span>`;
                } else {
                    // Use theme's primary color (cyan from theme)
                    statusMessage.innerHTML = `<span class="text-cyan-400 font-medium mt-1">✨ New Email: Ready for registration.</span>`;
                }
            } catch (error) {
                console.error("Error checking email status:", error);
                // Use theme's error color (red from theme)
                statusMessage.innerHTML = `<span class="text-red-400 mt-1">Error checking email.</span>`;
            }
        }

        window.handleForgotPasswordLink = function() {
            const emailInput = document.getElementById('email');
            const prefilledEmail = emailInput ? emailInput.value : '';
            renderView('forgot-password-email', { email: prefilledEmail });
        }
        
        window.handleSendResetLink = async function() {
            const emailInput = document.getElementById('reset-email');
            const email = emailInput ? emailInput.value.trim() : null;
            const submitBtn = document.getElementById('reset-submit-btn');

            if (!email || !email.includes('@')) {
                showMessage('Missing Email', 'Please enter your email address to proceed.');
                return;
            }
            
            // Use theme's loading spinner style
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;

            try {
                await sendPasswordResetEmail(auth, email);
                renderView('forgot-password-confirmation', { email: email });

            } catch (error) {
                console.error('Password reset link failed:', error);
                
                if (error.code === 'auth/user-not-found') {
                    renderView('forgot-password-confirmation', { email: email });
                } else {
                    showMessage('Reset Failed', 'Could not send reset email. Please ensure the email is correct.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Send Reset Link';
                }
            }
        }
       async function handleRegister(e) {
    e.preventDefault();

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const submitBtn = document.getElementById('auth-submit-btn');

    // 1️⃣ Validate Email With MailboxLayer (Mailboxer)
    const mailboxerApiKey = "b0998078cdf07e93957ed8e32a1cc881"; 

    try {
        // Call MailboxLayer API
        const res = await fetch(`https://apilayer.net/api/check?access_key=${mailboxerApiKey}&email=${email}`);
        const data = await res.json();

        // Email format invalid
        if (!data.format_valid) {
            return showMessage("Invalid Email", "Please enter a valid email address.");
        }

        // No MX record → cannot receive emails
        if (!data.mx_found) {
            return showMessage("Email Not Deliverable", "This email provider cannot receive messages. Try another email.");
        }

        // High risk temporary/disposable address
        if (data.disposable) {
            return showMessage("Email Not Allowed", "Disposable emails are not allowed. Please use your real email.");
        }

        // SMTP check failed = very likely invalid mailbox
        if (!data.smtp_check) {
            return showMessage(
                "Email Seems Incorrect",
                "This email can't be reached. Please double-check your address."
            );
        }

    } catch (err) {
        console.error("Mailboxer API error:", err);
        return showMessage("Validation Error", "Could not validate email. Try again.");
    }

    // 2️⃣ Email Passed All Checks → proceed with your registration flow

    // Show popup immediately (no loader)
    showMessage(
        "Verify Your Email",
        "A verification link will be sent. Please check your inbox.",
        null
    );

    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const newUser = userCredential.user;

        await sendEmailVerification(newUser);

        // Save profile to Firestore
        const userDocRef = doc(db, `artifacts/${canvasAppId}/users/${newUser.uid}/user_data/profile`);
        await setDoc(userDocRef, {
            email: newUser.email,
            emailVerified: false,
            createdAt: new Date(),
        });

        await signOut(auth);

        showMessage(
            "Registration Successful!",
            "Verification link sent to your email. Please verify before logging in.",
            () => renderView("login")
        );

    } catch (error) {
        console.error("Registration failed:", error);
        let message = "An error occurred. Please try again.";

        if (error.code === "auth/weak-password") {
            message = "Password should be at least 6 characters.";
        } else if (error.code === "auth/email-already-in-use") {
            message = "This email is already registered.";
        }

        showMessage("Registration Failed", message);

    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Register Account";
    }
}



        async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    const submitBtn = document.getElementById('auth-submit-btn');
    const oldText = "Sign In";
    submitBtn.disabled = true;
    submitBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;

    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        if (!user.emailVerified) {
            await signOut(auth);
            showMessage("Email Not Verified", "Please verify your email first.");
            submitBtn.disabled = false;
            submitBtn.textContent = oldText;
            return;
        }

        // ⭐ EMAIL-BASED MYSQL CHECK ⭐
       const response = await fetch(`https://profile-x1mi.onrender.com/get-profile-by-email/${email}`);

        const data = await response.json();

        if (data.status === "success") {
            showMessage("Success!", "Redirecting...");
            setTimeout(() => { window.location.href = "dashboard.html"; }, 900);
        } else {
            showMessage("Complete Your Profile", "Redirecting...");
            setTimeout(() => { window.location.href = "profile2.html"; }, 900);
        }

    } catch (err) {
        console.error(err);
        showMessage("Login Failed", "Invalid email or password.");
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = oldText;
    }
}


async function handleGoogleSignIn(isLogin) {
    if (isSigningIn) return;
    isSigningIn = true;

    const googleBtn = document.getElementById('google-btn');
    const googleBtnText = document.getElementById('google-btn-text');
    if (googleBtn && googleBtnText) {
        googleBtn.disabled = true;
        googleBtnText.textContent = "Loading...";
    }

    const provider = new GoogleAuthProvider();

    try {
        const userCredential = await signInWithPopup(auth, provider);
        const user = userCredential.user;

        // ⭐ EMAIL-BASED MYSQL CHECK ⭐
        const email = user.email;

      const response = await fetch(`https://profile-x1mi.onrender.com/get-profile-by-email/${email}`);

        const data = await response.json();

        if (data.status === "success") {
            showMessage("Success!", "Redirecting...");
            setTimeout(() => { window.location.href = "dashboard.html"; }, 900);
        } else {
            showMessage("Complete Your Profile", "Redirecting...");
            setTimeout(() => { window.location.href = "profile2.html"; }, 900);
        }

    } catch (error) {
        console.error("Google Sign-In failed:", error);
        showMessage("Sign-In Failed", error.message);
    } finally {
        isSigningIn = false;
        renderView(currentView);
    }
}


        
        async function handleLogout() {
            try {
                await signOut(auth);
                showMessage('Logged Out', 'You have been successfully logged out. Redirecting to login...');
                
                window.location.href = 'login2.html';

            } catch (error) {
                console.error('Logout failed:', error);
                showMessage('Logout Failed', 'Could not log out. Please try again.');
            }
        }

        // --- Rendering Functions (Internal to single file navigation) ---

        function renderAuthForm(isLogin) {
            const title = isLogin ? 'Welcome Back!' : 'Start Your Journey';
            const subtitle = isLogin ? 'Sign in to monitor your well-being.' : 'Create an account to begin stress prediction.';
            const submitText = isLogin ? 'Sign In' : 'Register Account';
            const toggleText = isLogin ? 'Need an account?' : 'Already have an account?';
            const googleActionText = isLogin ? 'Sign in with Google' : 'Register with Google';
            const toggleView = isLogin ? 'register' : 'login';
            const submitHandler = isLogin ? 'handleLogin(event)' : 'handleRegister(event)';
            
            // Link to the reset link flow (Re-skinned link)
            const forgotPasswordHtml = isLogin ? `
                <div class="flex items-center justify-end w-full">
                    <button type="button" onclick="handleForgotPasswordLink()" class="text-xs font-medium text-cyan-400 hover:text-cyan-300 transition duration-150">
                        Forgot Password?
                    </button>
                </div>
            ` : '';

            // Social Login (Re-skinned divider and button)
            const socialLoginHtml = `
                <div class="relative pt-2">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-700"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-slate-800 text-gray-400">Or use social login</span>
                    </div>
                </div>
                
                <button id="google-btn" onclick="handleGoogleSignIn(${isLogin});" ${isSigningIn ? 'disabled' : ''}
                    class="w-full flex justify-center items-center py-3 px-4 rounded-xl shadow-md text-lg font-semibold border transition duration-200 ease-in-out 
                    ${isSigningIn 
                        ? 'bg-slate-900 text-gray-500 cursor-not-allowed border-gray-700' 
                        : 'bg-slate-800 text-gray-300 border-gray-700 hover:bg-slate-700 transform hover:scale-[1.01] active:scale-[0.99]'}"
                >
                    ${GoogleIcon()}
                    <span id="google-btn-text">${isSigningIn ? 'Loading...' : googleActionText}</span>
                </button>
            `;

            // Main Auth Form (Re-skinned)
            // Note: The glass-card now has max-w-sm to ensure it doesn't stretch to the 450px container width
            return `
                <div class="w-full max-w-sm p-8 space-y-6 glass-card rounded-2xl mx-auto my-auto">
                    <div class="flex flex-col items-center">
                        ${AppLogoIcon()} <h2 class="mt-4 text-3xl font-extrabold gradient-text">${title}</h2>
                        <p class="text-sm text-gray-400 mt-1">${subtitle}</p>
                    </div>

                    <form class="space-y-4" onsubmit="${submitHandler}; return false;">
                        <div class="space-y-4">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                                <input type="email" id="email" required placeholder="you@app.com" onblur="checkEmailStatus()"
                                    class="w-full px-4 py-3 bg-slate-800 border border-gray-700 rounded-xl focus:border-cyan-500 focus:ring-0 text-gray-300 placeholder-gray-500 transition duration-150 ease-in-out shadow-sm text-base">
                                <div id="email-status-message" class="text-sm pt-1"></div> 
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                                <input type="password" id="password" required placeholder="Min 6 characters"
                                    class="w-full px-4 py-3 bg-slate-800 border border-gray-700 rounded-xl focus:border-cyan-500 focus:ring-0 text-gray-300 placeholder-gray-500 transition duration-150 ease-in-out shadow-sm text-base">
                            </div>
                        </div>
                        
                        ${forgotPasswordHtml}

                        <button type="submit" id="auth-submit-btn"
                            class="w-full flex justify-center items-center py-3 px-4 rounded-xl shadow-lg text-lg font-semibold text-white bg-gradient-to-r from-cyan-500 to-purple-600 hover:from-cyan-400 hover:to-purple-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition duration-200 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                            ${submitText}
                        </button>
                    </form>

                    ${socialLoginHtml}

                    <p class="text-center text-sm text-gray-400 pt-2">
                        ${toggleText}
                        <button onclick="renderView('${toggleView}')"
                            class="font-semibold text-cyan-400 hover:text-cyan-300 transition duration-150">
                            ${isLogin ? 'Register now' : 'Sign in'}
                        </button>
                    </p>
                </div>
            `;
        }

        /**
         * Renders the view for submitting the password reset email (Re-skinned)
         */
        function renderForgotPasswordEmail(email = '') {
            return `
                <div class="w-full max-w-sm p-8 space-y-6 glass-card rounded-2xl mx-auto my-auto">
                    <div class="flex flex-col items-center text-center">
                        ${AppLogoIcon()}
                        <h2 class="mt-4 text-3xl font-extrabold gradient-text">Reset Password</h2>
                        <p class="text-sm text-gray-400 mt-1">Enter your email and we'll send a secure password reset link.</p>
                    </div>

                    <form class="space-y-4" onsubmit="handleSendResetLink(); return false;">
                        <div>
                            <label for="reset-email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                            <input type="email" id="reset-email" required placeholder="you@app.com" value="${email}"
                                class="w-full px-4 py-3 bg-slate-800 border border-gray-700 rounded-xl focus:border-cyan-500 focus:ring-0 text-gray-300 placeholder-gray-500 transition duration-150 ease-in-out shadow-sm text-base">
                        </div>
                        
                        <button type="submit" id="reset-submit-btn"
                            class="w-full flex justify-center items-center py-3 px-4 rounded-xl shadow-lg text-lg font-semibold text-white bg-gradient-to-r from-cyan-500 to-purple-600 hover:from-cyan-400 hover:to-purple-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition duration-200 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                            Send Reset Link
                        </button>
                    </form>

                    <p class="text-center text-sm text-gray-400 pt-2">
                        <button onclick="renderView('login')"
                            class="font-semibold text-cyan-400 hover:text-cyan-300 transition duration-150">
                            Go back to Sign In
                        </button>
                    </p>
                </div>
            `;
        }
        
        /**
         * Renders the confirmation view (Re-skinned)
         */
        function renderForgotPasswordConfirmation(email) {
            return `
                <div class="w-full max-w-sm p-8 space-y-6 glass-card rounded-2xl mx-auto my-auto text-center">
                    <div class="flex flex-col items-center">
                        ${EmailSentIcon('w-12 h-12 text-cyan-400')}
                        <h2 class="mt-4 text-3xl font-extrabold gradient-text">Check Your Inbox!</h2>
                        <p class="text-gray-300 mt-2 text-sm">
                            A password reset link has been sent to:<br><span class="font-semibold text-cyan-400 break-words">${email}</span>
                        </p>
                        <p class="text-xs text-gray-500 mt-4">
                            Click the link in the email to set your new password securely. Remember to check your spam folder!
                        </p>
                    </div>
                    
                    <button onclick="renderView('login');" 
                        class="mt-4 w-full py-3 px-4 rounded-xl shadow-lg text-lg font-semibold text-white bg-gradient-to-r from-cyan-500 to-purple-600 hover:from-cyan-400 hover:to-purple-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition duration-200 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                        Back to Login
                    </button>
                </div>
            `;
        }


        /**
         * Renders the minimal Logged-in Status view (Re-skinned)
         */
        function renderDashboard(user) {
            return `
                <div class="w-full max-w-sm p-8 space-y-6 glass-card rounded-2xl mx-auto my-auto text-center">
                    <h2 class="text-3xl font-extrabold gradient-text">Authentication Successful</h2>
                    <p class="text-gray-300 text-sm">
                        Welcome, <span class="font-semibold text-cyan-400 break-words">${user.email || 'User'}</span>!
                    </p>
                    <p class="text-xs text-gray-500 break-words mt-1">
                        User ID: ${user.uid}
                    </p>

                    <button onclick="handleLogout()" 
                        class="mt-4 w-full py-3 px-4 rounded-xl shadow-lg text-lg font-semibold text-white bg-gradient-to-r from-rose-500 to-red-600 hover:from-rose-600 hover:to-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-rose-400 transition duration-200 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                        Logout
                    </button>
                </div>
            `;
        }

        /**
         * Renders the Loading view (Re-skinned)
         */
        function renderLoading() {
            return `
                <div class="min-h-screen flex flex-col justify-center items-center">
                    <div class="flex flex-col items-center glass-card p-8 rounded-xl shadow-lg">
                        <div class="w-8 h-8 border-4 border-gray-700 border-t-cyan-400 rounded-full animate-spin mb-4"></div>
                        <p class="text-gray-300">Initializing App...</p>
                    </div>
                </div>
            `;
        }

        /**
         * Main function to render the current application view.
         */
        window.renderView = function(view, params = {}) {
            currentView = view;
            // appContainer.innerHTML = ''; // This is handled by the render functions
            
            let htmlContent = '';
            const currentUser = auth ? auth.currentUser : null;

            if (view === 'login') {
                htmlContent = renderAuthForm(true);
            } else if (view === 'register') {
                htmlContent = renderAuthForm(false);
            } else if (view === 'forgot-password-email') {
                htmlContent = renderForgotPasswordEmail(params.email);
            } else if (view === 'forgot-password-confirmation') { 
                htmlContent = renderForgotPasswordConfirmation(params.email);
            } else if (view === 'dashboard' && currentUser) {
                htmlContent = renderDashboard(currentUser); 
            } else {
                // Default to loading if auth state is not yet known
                htmlContent = renderLoading();
            }

            // We render the content *inside* the app-container
            // The app-container itself is static in the HTML body
            const target = document.getElementById('app-container');
            
            // Clear previous content and render new
            while (target.firstChild) {
                target.removeChild(target.lastChild);
            }
            target.insertAdjacentHTML('beforeend', htmlContent);
            
            // Re-bind listener after render
            const emailInput = document.getElementById('email');
            if (emailInput) {
                emailInput.onblur = checkEmailStatus;
            }
        };
        
        // Expose functions globally for event handlers in the HTML content
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.handleGoogleSignIn = handleGoogleSignIn;
        window.handleLogout = handleLogout;
        window.checkEmailStatus = checkEmailStatus; 
        window.showMessage = showMessage;
        window.handleForgotPasswordLink = handleForgotPasswordLink;
        window.handleSendResetLink = handleSendResetLink; 

        // --- FIREBASE INITIALIZATION ---
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
onAuthStateChanged(auth, async (currentUser) => {

    // ⭐ Step 1: Check logout flag
    const justLoggedOut = localStorage.getItem("justLoggedOut");

    if (justLoggedOut === "true") {
        // Prevent ANY redirect after logout
        localStorage.removeItem("justLoggedOut");
        renderView("login");
        return;
    }

    // ⭐ Step 2: User is logged in
    if (currentUser) {
        if (!currentUser.isAnonymous) {

            // Email verified
            if (currentUser.emailVerified) {

                try {
                    // ⭐ EMAIL-BASED MYSQL CHECK (unchanged)
                    const email = currentUser.email;

                   const response = await fetch(`https://profile-x1mi.onrender.com/get-profile-by-email/${email}`);

                    const data = await response.json();

                    // ⭐ Profile exists → dashboard
                    if (data.status === "success") {
                        if (!window.location.pathname.toLowerCase().includes("dashboard.html")) {
                            window.location.href = "dashboard.html";
                        }
                    }
                    // ⭐ Profile missing → profile2.html
                    else {
                        if (!window.location.pathname.toLowerCase().includes("profile2.html")) {
                            window.location.href = "profile2.html";
                        }
                    }

                } catch (err) {
                    console.error("MySQL email check failed:", err);
                }

            } else {
                // Email NOT verified → force sign out (your logic kept)
                if (currentView === "login" || currentView === "register") {
                    await signOut(auth);
                }
            }

        } else {
            // Anonymous user → show login
            if (currentView !== "forgot-password-email" &&
                currentView !== "forgot-password-confirmation") {
                renderView("login");
            }
        }

    } else {
        // ⭐ Step 3: No user → show login screen
        if (currentView !== "forgot-password-email" &&
            currentView !== "forgot-password-confirmation") {

            if (currentView === "loading" || currentView === "dashboard") {
                renderView("login");
            }
        }
    }
});



        
        // Optimized Start: Immediately render the Login form
        window.renderView('login');
    </script>
</body>
</html>
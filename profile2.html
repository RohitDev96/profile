<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Edit Profile - MindMetrics</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
  * { font-family: 'Inter', sans-serif; }
  body { background: linear-gradient(135deg,#0a0e27 0%,#1a1f3a 50%,#0f1419 100%); min-height:100vh; }
  #mobile-container { max-width:450px; margin:auto; min-height:100vh; padding-bottom:40px; }
  .glass-card{ background:rgba(30,41,59,0.7); backdrop-filter:blur(20px); border:1px solid rgba(148,163,184,0.1); }
  .gradient-text{ background:linear-gradient(135deg,#06b6d4 0%,#8b5cf6 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .input-style{ background-color:rgba(30,41,59,0.9) !important; border:1px solid rgba(148,163,184,0.2); color:#f8fafc !important; padding:0.75rem; border-radius:0.5rem; transition:border-color .2s; }
  .input-style:focus{ outline:none; border-color:#06b6d4; box-shadow:0 0 0 1px #06b6d4; }
  input:-webkit-autofill { -webkit-box-shadow:0 0 0 30px rgba(30,41,59,0.9) inset !important; -webkit-text-fill-color:#fff !important; }
</style>
</head>

<body>
  <div id="mobile-container" class="p-6">
    <nav class="sticky top-0 z-10 glass-card border-b border-cyan-500/20 mb-6">
      <div class="h-16 flex items-center px-4">
        <button onclick="window.history.back()" class="text-gray-400 hover:text-cyan-400 transition mr-4">⬅</button>
        <h1 class="text-xl font-bold text-white">Edit Profile</h1>
      </div>
    </nav>
<!-- Loading Skeleton -->
<div id="loadingSkeleton" class="space-y-4 p-6 animate-pulse">
  <div class="w-28 h-28 bg-slate-700/50 rounded-full mx-auto"></div>
  
  <div class="glass-card rounded-xl p-6 space-y-4">
    <div class="h-4 bg-slate-700/50 rounded w-2/3"></div>
    <div class="h-10 bg-slate-700/50 rounded"></div>
    <div class="h-10 bg-slate-700/50 rounded"></div>
    <div class="h-10 bg-slate-700/50 rounded"></div>
    <div class="h-10 bg-slate-700/50 rounded"></div>
    <div class="h-10 bg-slate-700/50 rounded"></div>
  </div>
</div>
<div id="profileContent" class="space-y-6 hidden">


      <!-- Profile Image -->
      <div class="flex flex-col items-center space-y-4">
       <div class="w-28 h-28 relative rounded-full shadow-xl border-4 border-slate-700 overflow-hidden">
    <!-- Image -->
    <img id="profileImage" class="w-full h-full object-cover absolute inset-0 opacity-0">

    <!-- Initials Fallback -->
    <div id="initialsFallback" class="w-full h-full bg-gradient-to-br from-cyan-400 to-purple-600 
    flex items-center justify-center text-3xl text-white font-bold absolute inset-0">
        ??
    </div>
</div>

        <input id="imageInput" type="file" accept="image/*" class="hidden">
        <div class="flex gap-3">
          <button id="changePhotoBtn" class="text-sm font-semibold gradient-text hover:opacity-80">Change Photo</button>
          <button id="removePhotoBtn" class="text-sm font-semibold text-gray-400 hover:text-red-400">Remove</button>
        </div>
      </div>

      <!-- Form -->
      <div class="glass-card rounded-xl p-6 space-y-4">
        <h2 class="text-lg font-bold gradient-text pb-2 border-b border-gray-700/50">Personal Details</h2>

        <div>
          <label class="text-sm text-gray-400">Full Name</label>
          <input id="fullName" class="input-style w-full" type="text" />
        </div>

        <div>
          <label class="text-sm text-gray-400">Phone Number</label>
          <input id="phone" class="input-style w-full" type="tel" />
        </div>

        <div>
          <label class="text-sm text-gray-400">Email</label>
          <input id="email" class="input-style w-full" type="email" readonly />
        </div>

        <div>
          <label class="text-sm text-gray-400">Bio/Tagline</label>
          <textarea id="bio" class="input-style w-full resize-none" rows="3"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-400">Date of Birth</label>
            <input id="dob" type="date" class="input-style w-full" />
          </div>
          <div>
            <label class="text-sm text-gray-400">Age</label>
            <input id="age" type="number" readonly class="input-style w-full" />
          </div>
        </div>

        <div>
          <label class="text-sm text-gray-400">Gender</label>
          <select id="gender" class="input-style w-full">
            <option value="">Select Gender</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </div>
      </div>

      <button id="saveBtn" class="w-full py-3 px-3 bg-gradient-to-r from-cyan-500 to-purple-600 text-white text-lg font-bold rounded-xl hover:scale-[1.01] shadow-lg transition">Save Changes</button>
    </div>
  </div>

<!-- ========================= -->
<!--     JAVASCRIPT MODULE     -->
<!-- ========================= -->
<script type="module">

/* ============================
   LOADING UI SETUP
=============================== */
document.getElementById("loadingSkeleton").style.display = "block";
document.getElementById("profileContent").classList.add("hidden");


/* ============================
   FIREBASE AUTH SETUP
=============================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

function generateInitials(name) {
  if (!name) return "U";
  const parts = name.trim().split(" ");
  return parts.length > 1
    ? (parts[0][0] + parts[parts.length - 1][0]).toUpperCase()
    : parts[0].substring(0, 2).toUpperCase();
}

const firebaseConfig = {
  apiKey: "AIzaSyDd7NoHbxWpbhERrKYT2Pj2dhHWu4LhXJA",
  authDomain: "stresspredictapp.firebaseapp.com",
  projectId: "stresspredictapp",
  storageBucket: "stresspredictapp.firebasestorage.app",
  messagingSenderId: "333834939182",
  appId: "1:333834939182:web:432df2fad26f37baa328bf",
  measurementId: "G-CFJ2B9FG9J"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);


/* ============================
   BACKEND BASE URL (MONGODB)
=============================== */
const API_BASE = "http://localhost:5000";




/* ============================
   GLOBAL VARIABLES
=============================== */
let uploadedImageBase64 = null;

const profileImageEl = document.getElementById("profileImage");
const initialsEl = document.getElementById("initialsFallback");
const imageInput = document.getElementById("imageInput");


/* ============================
   AGE AUTO CALCULATION
=============================== */
function calcAge(dob) {
  if (!dob) return "";
  const birth = new Date(dob);
  const diff = Date.now() - birth.getTime();
  return Math.abs(new Date(diff).getUTCFullYear() - 1970);
}

document.getElementById("dob").addEventListener("change", (e) => {
  document.getElementById("age").value = calcAge(e.target.value);
});


/* ============================
   LOAD PROFILE FROM MONGODB
=============================== */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("Not logged in. Redirecting...");
    location.href = "login2.html";
    return;
  }

  const email = user.email;
  document.getElementById("email").value = email;

  try {
    const res = await fetch(`${API_BASE}/get-profile-by-email/${email}`);
    const data = await res.json();

    // STOP showing skeleton and show UI
    document.getElementById("loadingSkeleton").style.display = "none";
    document.getElementById("profileContent").classList.remove("hidden");

    if (data.status === "success") {
      const u = data.profile;

      // Fill fields
      document.getElementById("fullName").value = u.fullName || "";
      document.getElementById("phone").value = u.phone || "";
      document.getElementById("bio").value = u.bio || "";
      document.getElementById("dob").value = u.dob || "";
      document.getElementById("age").value = u.age || (u.dob ? calcAge(u.dob) : "");
      document.getElementById("gender").value = u.gender || "";

      const displayName = u.fullName || email.split("@")[0];
      initialsEl.textContent = generateInitials(displayName);

      if (u.profileImage) {
        profileImageEl.src = "data:image/jpeg;base64," + u.profileImage;
        profileImageEl.style.opacity = 1;
        initialsEl.style.opacity = 0;
        uploadedImageBase64 = u.profileImage;
      } else {
        profileImageEl.style.opacity = 0;
        initialsEl.style.opacity = 1;
      }

    } else {
      // First-time user
      const displayName = email.split("@")[0];
      initialsEl.textContent = generateInitials(displayName);
      profileImageEl.style.opacity = 0;
      initialsEl.style.opacity = 1;
    }

  } catch (err) {
    console.error("Load profile error:", err);

    initialsEl.textContent = generateInitials(email.split("@")[0]);
    profileImageEl.style.opacity = 0;
    initialsEl.style.opacity = 1;
  }
});


/* ============================
   IMAGE HANDLING
=============================== */
document.getElementById("changePhotoBtn").addEventListener("click", () => {
  imageInput.click();
});

imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    uploadedImageBase64 = e.target.result.split(",")[1];
    profileImageEl.src = e.target.result;
    profileImageEl.style.opacity = 1;
    initialsEl.style.opacity = 0;
  };
  reader.readAsDataURL(file);
});


/* ============================
   REMOVE PHOTO
=============================== */
document.getElementById("removePhotoBtn").addEventListener("click", () => {
  uploadedImageBase64 = null;
  imageInput.value = "";

  profileImageEl.style.opacity = 0;
  initialsEl.style.opacity = 1;

  const email = document.getElementById("email").value;
  const fullName = document.getElementById("fullName").value;
  initialsEl.textContent = generateInitials(fullName || email.split("@")[0]);
});


/* ============================
   SAVE PROFILE TO MONGODB
=============================== */
document.getElementById("saveBtn").addEventListener("click", async () => {
  const btn = document.getElementById("saveBtn");
  const originalText = btn.innerText;

  btn.innerText = "Saving...";
  btn.disabled = true;

  const email = document.getElementById("email").value;
  const dobVal = document.getElementById("dob").value;

  const payload = {
    email,
    fullName: document.getElementById("fullName").value,
    phone: document.getElementById("phone").value,
    bio: document.getElementById("bio").value,
    dob: dobVal || "",
    age: dobVal ? calcAge(dobVal) : "",
    gender: document.getElementById("gender").value || "",
    profileImage: uploadedImageBase64
  };

  try {
    const res = await fetch(`${API_BASE}/save-profile-by-email`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const data = await res.json();

    if (data.status === "success") {
      btn.innerText = "Saved ✔";
      btn.classList.add("bg-green-600");
      setTimeout(() => (location.href = "dashboard.html"), 1200);
    } else {
      btn.innerText = "Error ❌";
      btn.classList.add("bg-red-600");
    }

  } catch (err) {
    console.log("Save error:", err);
    btn.innerText = "Server Error ❌";
    btn.classList.add("bg-red-600");
  }

  setTimeout(() => {
    btn.innerText = originalText;
    btn.disabled = false;
    btn.classList.remove("bg-green-600", "bg-red-600");
  }, 2000);
});

</script>

</body>
</html>

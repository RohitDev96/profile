<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stress Prediction Auth</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Simple loading spinner */
        .spinner {
            border-top-color: #4f46e5;
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">
        <!-- Views will be rendered here -->
    </div>

    <!-- Custom Modal for Messages (replaces alert() and confirm()) -->
    <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300" aria-modal="true" role="dialog">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-xl font-semibold mb-3 text-gray-800">Message</h3>
            <p id="modal-content" class="text-gray-600 mb-4"></p>
            <button id="modal-close-btn" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition duration-150">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth, onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, 
            GoogleAuthProvider, signInWithPopup, fetchSignInMethodsForEmail, sendEmailVerification 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            // Only essential Firestore imports kept
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARS & CONFIG ---
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Explicit Firebase configuration provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyDd7NoHbxWpbhERrKYT2Pj2dhHWu4LhXJA",
            authDomain: "stresspredictapp.firebaseapp.com",
            projectId: "stresspredictapp",
            storageBucket: "stresspredictapp.firebasestorage.app",
            messagingSenderId: "333834939182",
            appId: "1:333834939182:web:432df2fad26f37baa328bf",
            measurementId: "G-CFJ2B9FG9J"
        };
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined'
            ? __initial_auth_token
            : null;
        // --- END GLOBAL VARS ---

        let app;
        let auth;
        let db;
        let currentView = 'login'; // Optimized: Default to 'login' instantly
        let isSigningIn = false;
        let modalCallback = null; // Callback function storage

        const appContainer = document.getElementById('app-container');
        const modal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            // Execute callback if it exists
            if (modalCallback) {
                modalCallback();
                modalCallback = null; // Clear callback after execution
            }
        });

        /**
         * Custom message utility to replace alert().
         * @param {string} title - Modal title.
         * @param {string} message - Modal content.
         * @param {Function} [callback] - Function to run when the modal is closed.
         */
        function showMessage(title, message, callback = null) {
            modalTitle.textContent = title;
            modalContent.textContent = message;
            modal.classList.remove('hidden'); // This shows the modal
            modalCallback = callback; // Set the callback
        }

        // --- Icon Components ---

        function CalmingIcon(className = "w-10 h-10 text-indigo-600") {
             return `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
                <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z" />
                <path d="M12 4v16" />
                <path d="M16 12h-8" />
            </svg>`;
        }

        function GoogleIcon() {
             return `
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="w-5 h-5 mr-3">
                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.04l7.65 5.92C11.3 14.54 17.5 9.5 24 9.5z"></path>
                <path fill="#4285F4" d="M46.61 24c0-.98-.1-1.85-.25-2.73H24v5.18h12.55c-.56 2.87-2.31 5.2-4.95 6.84l7.65 5.92c4.7-4.57 7.42-11.45 7.42-18.71z"></path>
                <path fill="#FBBC05" d="M10.22 30.74l-7.65-5.92C1.38 27.56 1 30.68 1 34c0 3.32.38 6.44 1.57 9.28l7.65-5.92c-.75-1.81-1.17-3.72-1.17-5.34z"></path>
                <path fill="#34A853" d="M24 48c6.47 0 11.9-2.38 16.19-6.39l-7.65-5.92c-2.64 1.64-4.39 3.97-4.95 6.84H24v-5.18c-6.5 0-12.7-5.04-14.86-10.96l-7.65 5.92C6.51 42.62 14.62 48 24 48z"></path>
                <path fill="none" d="M0 0h48v48H0z"></path>
            </svg>`;
        }

        function EmailSentIcon(className = "w-12 h-12 text-green-500") { 
            return `
            <svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
            </svg>`;
        }


        /**
         * Provides a hint about the email status.
         */
        async function checkEmailStatus() {
            const emailInput = document.getElementById('email');
            const email = emailInput ? emailInput.value.trim() : '';
            const statusMessage = document.getElementById('email-status-message');
            
            statusMessage.innerHTML = ''; 
            statusMessage.className = 'text-sm'; 

            if (!email || !email.includes('@') || email.length < 5) {
                return;
            }

            try {
                statusMessage.innerHTML = `<span class="text-gray-500">Checking email status...</span>`;
                
                const methods = await fetchSignInMethodsForEmail(auth, email);
                const isRegistered = methods && methods.length > 0;
                
                if (isRegistered) {
                    statusMessage.innerHTML = `<span class="text-green-600 font-medium mt-1">✅ Registered: Use this email to sign in.</span>`;
                } else {
                    statusMessage.innerHTML = `<span class="text-indigo-600 font-medium mt-1">✨ New Email: Ready for registration.</span>`;
                }
            } catch (error) {
                console.error("Error checking email status:", error);
                statusMessage.innerHTML = `<span class="text-red-500 mt-1">Error checking email.</span>`;
            }
        }

        /**
         * Handles the click on "Forgot Password?" link on the login screen.
         */
        window.handleForgotPasswordLink = function() {
            const emailInput = document.getElementById('email');
            const prefilledEmail = emailInput ? emailInput.value : '';
            // Renders the first step of the reset flow
            renderView('forgot-password-email', { email: prefilledEmail });
        }
        
        /**
         * Handles sending the secure Firebase password reset link.
         */
        window.handleSendResetLink = async function() {
            const emailInput = document.getElementById('reset-email');
            const email = emailInput ? emailInput.value.trim() : null;
            const submitBtn = document.getElementById('reset-submit-btn');

            if (!email || !email.includes('@')) {
                showMessage('Missing Email', 'Please enter your email address to proceed.');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-indigo-200 rounded-full animate-spin"></div>`;

            try {
                // 1. Send the native Firebase password reset link
                await sendPasswordResetEmail(auth, email);
                
                // 2. Move to confirmation view
                renderView('forgot-password-confirmation', { email: email });

            } catch (error) {
                console.error('Password reset link failed:', error);
                
                // Handle the case where the user isn't found, but still show confirmation for security
                if (error.code === 'auth/user-not-found') {
                    // Although the user might not exist, Firebase often treats this silently to prevent enumeration.
                    // We still show the confirmation page for a better UX, or a tailored message.
                     showMessage('Check Email', 'If this email is registered, a password reset link has been sent.');
                     renderView('forgot-password-confirmation', { email: email });
                } else {
                    showMessage('Reset Failed', 'Could not send reset email. Please ensure the email is correct.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Send Reset Link';
                }
            }
        }
        
        /**
         * Handles user registration with email and password.
         */
        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUser = userCredential.user;
                
                // --- Send Email Verification Link ---
                await sendEmailVerification(newUser);
                // ----------------------------------------

                // Store user data in Firestore (Private path)
                const userDocRef = doc(db, `artifacts/${canvasAppId}/users/${newUser.uid}/user_data/profile`);
                await setDoc(userDocRef, {
                    email: newUser.email,
                    emailVerified: false, // Initial status
                    createdAt: new Date(),
                });

                // Sign out the automatically logged-in session right away
                await signOut(auth); 

                // --- GUARANTEED POP-UP AND REDIRECT SEQUENCE ---
                // Show message, and pass the renderView('login') as a callback. 
                // The modal will appear, and the view will only switch upon clicking 'Close'.
                showMessage(
                    'Registration Successful!', 
                    'A **verification link** has been sent to your email. Please verify your address before signing in.',
                    // This callback runs when the modal is closed by the user
                    () => { renderView('login'); } 
                );
                // ------------------------------------------------
                
            } catch (error) {
                console.error('Registration failed:', error);
                if (error.code === 'auth/weak-password') {
                    showMessage('Registration Failed', 'Password should be at least 6 characters.');
                } else if (error.code === 'auth/email-already-in-use') {
                    showMessage('Registration Failed', 'This email address is already registered. Please switch to Sign In.');
                } else {
                    showMessage('Registration Failed', 'An error occurred during registration. Please try again.');
                }
            }
        }

        /**
         * Handles user login with email and password.
         */
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // --- Check Email Verification Status ---
                if (!user.emailVerified) {
                    await signOut(auth);
                    showMessage('Login Blocked', 'Your email address is not verified. Please check your inbox for the verification link.');
                    return;
                }
                // --------------------------------------------

                showMessage('Success!', 'Login successful. Redirecting to dashboard...');
                
                // --- REQUIRED REDIRECTION AFTER LOGIN ---
                window.location.href = 'dashboard.html'; 
                // ----------------------------------------

            } catch (error) {
                console.error('Login failed:', error);
                if (error.code === 'auth/invalid-email' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    showMessage('Login Failed', 'Invalid email or password.');
                } else if (error.code === 'auth/user-not-found') {
                    showMessage('Login Failed', 'This email is not registered. We are taking you to the Register page.');
                    renderView('register');
                } else if (error.code === 'auth/too-many-requests') {
                    showMessage('Login Failed', 'Access to this account has been temporarily blocked due to too many failed login attempts.');
                } else {
                    showMessage('Login Failed', 'An unexpected error occurred during login.');
                }
            }
        }

        /**
         * Handles Google Sign-In. (Logic remains the same)
         */
        async function handleGoogleSignIn(isLogin) {
            if (isSigningIn) return;
            isSigningIn = true;
            
            const googleBtn = document.getElementById('google-btn');
            const googleBtnText = document.getElementById('google-btn-text');
            if (googleBtn && googleBtnText) {
                 googleBtn.disabled = true;
                 googleBtnText.textContent = 'Loading...';
            }
            
            const provider = new GoogleAuthProvider();
            try {
                const userCredential = await signInWithPopup(auth, provider);
                // Google sign-in automatically verifies the email
                showMessage('Success!', isLogin ? 'Signed in with Google. Redirecting...' : 'Registered with Google. Redirecting...');
                
                // --- REQUIRED REDIRECTION AFTER GOOGLE LOGIN ---
                if (userCredential.user) {
                    window.location.href = 'dashboard.html';
                }
                // ----------------------------------------

            } catch (error) {
                console.error('Google Sign-In failed:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showMessage('Sign-In Cancelled', 'Google sign-in was cancelled by the user.');
                } else if (error.code === 'auth/unauthorized-domain') {
                    showMessage(
                        'Configuration Error', 
                        'Google Sign-In failed because your Firebase project does not recognize this application\'s domain. Use Email/Password sign-in instead.'
                    );
                } else {
                    showMessage('Sign-In Failed', 'Google sign-in failed. Error Code: ' + error.code);
                }
            } finally {
                isSigningIn = false;
                renderView(currentView); 
            }
        }
        
        /**
         * Handles user logout. (Logic remains the same)
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                showMessage('Logged Out', 'You have been successfully logged out. Redirecting to login...');
                
                // When logging out, we should also redirect to the login page
                window.location.href = 'login.html';

            } catch (error) {
                console.error('Logout failed:', error);
                showMessage('Logout Failed', 'Could not log out. Please try again.');
            }
        }

        // --- Rendering Functions (Internal to single file navigation) ---

        /**
         * Renders the authentication form (Login or Register).
         */
        function renderAuthForm(isLogin) {
            const title = isLogin ? 'Welcome Back!' : 'Start Your Journey';
            const subtitle = isLogin ? 'Sign in to monitor your well-being.' : 'Create an account to begin stress prediction.';
            const submitText = isLogin ? 'Sign In' : 'Register Account';
            const toggleText = isLogin ? 'Need an account?' : 'Already have an account?';
            const googleActionText = isLogin ? 'Sign in with Google' : 'Register with Google';
            const toggleView = isLogin ? 'register' : 'login';
            const submitHandler = isLogin ? 'handleLogin(event)' : 'handleRegister(event)';
            
            // Link to the reset link flow
            const forgotPasswordHtml = isLogin ? `
                <div class="flex items-center justify-end w-full">
                    <button type="button" onclick="handleForgotPasswordLink()" class="text-xs font-medium text-indigo-600 hover:text-indigo-500 transition duration-150">
                        Forgot Password?
                    </button>
                </div>
            ` : '';

            const socialLoginHtml = `
                <div class="relative pt-2">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">Or use social login</span>
                    </div>
                </div>
                
                <button id="google-btn" onclick="handleGoogleSignIn(${isLogin});" ${isSigningIn ? 'disabled' : ''}
                    class="w-full flex justify-center items-center py-3 px-4 rounded-xl shadow-md text-lg font-semibold border transition duration-200 ease-in-out 
                    ${isSigningIn 
                        ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
                        : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 transform hover:scale-[1.01] active:scale-[0.99]'}"
                >
                    ${GoogleIcon()}
                    <span id="google-btn-text">${isSigningIn ? 'Loading...' : googleActionText}</span>
                </button>
            `;


            return `
                <div class="w-full max-w-sm p-8 space-y-6 bg-white shadow-2xl rounded-2xl mx-auto my-auto">
                    <div class="flex flex-col items-center">
                        ${CalmingIcon()}
                        <h2 class="mt-4 text-3xl font-extrabold text-gray-900">${title}</h2>
                        <p class="text-sm text-gray-500 mt-1">${subtitle}</p>
                    </div>

                    <!-- EMAIL/PASSWORD FORM -->
                    <form class="space-y-4" onsubmit="${submitHandler}; return false;">
                        <div class="space-y-4">
                            <!-- Input Container 1: Email -->
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                <input type="email" id="email" required placeholder="you@app.com" onblur="checkEmailStatus()"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out shadow-sm text-base">
                                <div id="email-status-message" class="text-sm"></div> 
                            </div>
                            <!-- Input Container 2: Password -->
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="password" required placeholder="Min 6 characters"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out shadow-sm text-base">
                            </div>
                        </div>
                        
                        ${forgotPasswordHtml}

                        <button type="submit" id="auth-submit-btn"
                            class="w-full flex justify-center py-3 px-4 rounded-xl shadow-lg text-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                            ${submitText}
                        </button>
                    </form>

                    ${socialLoginHtml}

                    <p class="text-center text-sm text-gray-600 pt-2">
                        ${toggleText}
                        <button onclick="renderView('${toggleView}')"
                            class="font-semibold text-indigo-600 hover:text-indigo-500 transition duration-150">
                            ${isLogin ? 'Register now' : 'Sign in'}
                        </button>
                    </p>
                </div>
            `;
        }

        /**
         * Renders the view for submitting the password reset email (STEP 1).
         */
        function renderForgotPasswordEmail(email = '') {
            return `
                <div class="w-full max-w-sm p-8 space-y-6 bg-white shadow-2xl rounded-2xl mx-auto my-auto">
                    <div class="flex flex-col items-center text-center">
                        ${CalmingIcon()}
                        <h2 class="mt-4 text-3xl font-extrabold text-gray-900">Reset Password</h2>
                        <p class="text-sm text-gray-500 mt-1">Enter your email and we'll send a secure password reset link.</p>
                    </div>

                    <form class="space-y-4" onsubmit="handleSendResetLink(); return false;">
                        <div>
                            <label for="reset-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="reset-email" required placeholder="you@app.com" value="${email}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out shadow-sm text-base">
                        </div>
                        
                        <button type="submit" id="reset-submit-btn"
                            class="w-full flex justify-center items-center py-3 px-4 rounded-xl shadow-lg text-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                            Send Reset Link
                        </button>
                    </form>

                    <p class="text-center text-sm text-gray-600 pt-2">
                        <button onclick="renderView('login')"
                            class="font-semibold text-indigo-600 hover:text-indigo-500 transition duration-150">
                            Go back to Sign In
                        </button>
                    </p>
                </div>
            `;
        }
        
        /**
         * Renders the confirmation view that a reset link has been sent. (Replaces OTP/Change views)
         */
        function renderForgotPasswordConfirmation(email) {
            return `
                <div class="w-full max-w-sm p-8 space-y-6 bg-white shadow-2xl rounded-2xl mx-auto my-auto text-center">
                    <div class="flex flex-col items-center">
                        ${EmailSentIcon('w-12 h-12 text-green-500')}
                        <h2 class="mt-4 text-3xl font-extrabold text-gray-900">Check Your Inbox!</h2>
                        <p class="text-gray-600 mt-2 text-sm">
                            A password reset link has been sent to:<br><span class="font-semibold text-indigo-700 break-words">${email}</span>
                        </p>
                        <p class="text-xs text-gray-500 mt-4">
                            Click the link in the email to set your new password securely. Remember to check your spam folder!
                        </p>
                    </div>
                    
                    <button onclick="renderView('login');" 
                        class="mt-4 w-full py-3 px-4 rounded-xl shadow-lg text-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                        Back to Login
                    </button>
                </div>
            `;
        }


        /**
         * Renders the minimal Logged-in Status view.
         */
        function renderDashboard(user) {
            // This view is only rendered briefly if the app is accessed directly and auth state is cached.
            // In a real deployed environment, the user would already be on dashboard.html.
            return `
                <div class="w-full max-w-sm p-8 space-y-6 bg-white shadow-2xl rounded-2xl mx-auto my-auto text-center">
                    <h2 class="text-3xl font-extrabold text-green-600">Authentication Successful</h2>
                    <p class="text-gray-600 text-sm">
                        Welcome, <span class="font-semibold text-indigo-700 break-words">${user.email || 'User'}</span>!
                    </p>
                    <p class="text-xs text-gray-500 break-words mt-1">
                        User ID: ${user.uid}
                    </p>

                    <button onclick="handleLogout()" 
                        class="mt-4 w-full py-3 px-4 rounded-xl shadow-lg text-lg font-semibold text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400 transition duration-200 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                        Logout
                    </button>
                </div>
            `;
        }

        /**
         * Renders the Loading view.
         */
        function renderLoading() {
            return `
                <div class="min-h-screen flex flex-col justify-center items-center">
                    <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-lg">
                        <div class="w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4 spinner"></div>
                        <p class="text-gray-600">Initializing App...</p>
                    </div>
                </div>
            `;
        }

        /**
         * Main function to render the current application view.
         */
        window.renderView = function(view, params = {}) {
            currentView = view;
            appContainer.innerHTML = '';
            
            let htmlContent = '';
            const currentUser = auth ? auth.currentUser : null;

            if (view === 'login') {
                htmlContent = renderAuthForm(true);
            } else if (view === 'register') {
                htmlContent = renderAuthForm(false);
            } else if (view === 'forgot-password-email') {
                htmlContent = renderForgotPasswordEmail(params.email);
            } else if (view === 'forgot-password-confirmation') { // New confirmation view
                htmlContent = renderForgotPasswordConfirmation(params.email);
            } else if (view === 'dashboard' && currentUser) {
                // In a true environment, this scenario should redirect if not on dashboard.html
                // For the single file, we render the minimal dashboard view
                htmlContent = renderDashboard(currentUser); 
            } else {
                // If it's the default 'loading' view, we'll let the onAuthStateChanged logic handle it.
                // However, since we initialized currentView to 'login' now, this path is rarely taken.
                htmlContent = renderLoading();
            }

            appContainer.innerHTML = htmlContent;
            
            // Re-bind listeners after rendering
            const emailInput = document.getElementById('email');
            if (emailInput) {
                emailInput.onblur = checkEmailStatus;
            }
        };
        
        // Expose functions globally for event handlers in the HTML content
        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.handleGoogleSignIn = handleGoogleSignIn;
        window.handleLogout = handleLogout;
        window.checkEmailStatus = checkEmailStatus; 
        window.showMessage = showMessage;
        window.handleForgotPasswordLink = handleForgotPasswordLink;
        window.handleSendResetLink = handleSendResetLink; // Updated handler

        // --- FIREBASE INITIALIZATION ---
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // 1. Set up authentication state listener
        onAuthStateChanged(auth, async (currentUser) => {
            if (currentUser) {
                // User signed in 
                if (!currentUser.isAnonymous) {
                    // Redirect to dashboard if authenticated AND verified
                    if (currentUser.emailVerified) {
                        if (currentView !== 'dashboard') {
                            window.location.href = 'dashboard.html';
                        }
                    } else {
                         // User is unverified (just registered/unverified). No action needed here.
                    }
                } else {
                    // Anonymous user fallback to login
                    if (currentView !== 'forgot-password-email' && currentView !== 'forgot-password-confirmation') {
                         renderView('login'); 
                    }
                }
            } else {
                // User is not authenticated
                
                // If the user is not authenticated and is not in a password reset flow, show the login page
                if (currentView !== 'forgot-password-email' && currentView !== 'forgot-password-confirmation') {
                    // If the view is currently 'loading', switch it to 'login' now that the auth check is complete.
                    if (currentView === 'loading') {
                       renderView('login'); 
                    }
                }
            }
        });
        
        // Optimized Start: Immediately render the Login form to improve perceived speed.
        window.renderView('login');
    </script>
</body>
</html>